<!--?xml version="1.0" encoding="UTF-8"?-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<!-- D3.js -->
<script type="text/javascript" src="web3.js"></script>
<script type="text/javascript">

    var Web3 = require('web3');
    var web3 = new Web3();
    web3.setProvider(new web3.providers.HttpProvider("http://10.19.244.249:8545"));
    var blockWait=0;

    function account_exists(account){
        var accounts = web3.eth.accounts;
        for (var a in accounts)
        {
        	if(account=accounts[a]) return true;
        }
	return false;
    }

    function setAccounts() {
        var accounts = web3.eth.accounts;
        var selects="";
        for (var a in accounts)
        {
        	var balance = web3.fromWei(web3.eth.getBalance(accounts[a]).toNumber(),"ether");
		}
		if(selects==""){selects="<option selected='selected' value='"+accounts[a]+"'>"+accounts[a]+" ("+balance+" Ether)</option>";}
		else {selects=selects+"<option value='"+accounts[a]+"'>"+accounts[a]+" ("+balance+")</option>";}
		document.getElementById("account").innerHTML=selects;
    }

    function getContract(){
        var client = new XMLHttpRequest();
        client.open('GET','http://10.19.245.188:3000/daisee.contract',false);
        client.send();

        var source = client.responseText;
        var compiled = web3.eth.compile.solidity(source);
        var code = compiled.pledge.code;
        // contract json abi, this is autogenerated using solc CLI
        var abi = compiled.pledge.info.abiDefinition;

       var contract = web3.eth.contract(abi);
       Contract=contract.at("0x55ac826b180a9a816e961c4841b44208926b3164");
       Contract.count(function(error, result){ if(error) console.error(error); else document.getElementById("status").innerHTML="Currently "+ result.c+" pledges!";});
    }


    var Contract;
    getContract();



	function init(){
		listUsers();
	}

	function addUser(){
		var name=document.getElementById("name").value;
		alert("Contract has "+web3.eth.getBalance(pledgeContract.address));
		Contract.sajouterUsager(name,
			{ from: web3.eth.coinbase, gas: 2000000}
			, function(error, result){
			     if(error) console.error(error);
			     else console.log(result);
		         web3.eth.getBlockNumber(function(error, result){
		            if(error) console.error(error);
		            else {
			           blockWait=parseInt(result)+2;
			           update();
			        }
			     })
		    })
	}

	function setUsage(){ /*
		var prod=document.getElementById("production").value;
		var conso=document.getElementById("usage").value;

		pledgeContract.publier(service,
			{ from: owner, gas: 2000000}
			, function(error, result){ if(error) console.error(error); else console.log(result);
		pledgeContract.count(function(error, result){ if(error) console.error(error); else document.getElementById("status").innerHTML ="You cancelled pledge #"+(number+1)+"!";});});
		web3.eth.getBlockNumber(function(error, result){ if(error) console.error(error); else {
			blockWait=parseInt(result)+2;
			update();
			}}) */
	}




	function listUsers(){
/*		var content="";
		var overlays="";
		var count=pledgeContract.count();
		var number=count;
		while(number>0){
			number--;
			var service=toAscii(pledgeContract.service(number));
			var features=web3.toDecimal(pledgeContract.features(number));
			content+="<tr id='row"+number+"'><th>"+service+"</th><td><img src='"+toAscii(pledgeContract.logo1(number))+toAscii(pledgeContract.logo2(number))+"' height='30'/></td><td>"+summary(features)+"</td>";
			overlays+="<div id='detail"+number+"'>";
			overlays+="<table><th colspan='2'>Details</th><td rowspan='6'><div class='radar"+number+"'></td></div>";
			overlays+=show_detail("trust",features % 10);
			overlays+=show_detail("compliance",Math.floor(features/10) % 10);
			overlays+=show_detail("accessibility",Math.floor(features/100) % 10);
			overlays+=show_detail("diversities",Math.floor(features/1000) % 10);
			overlays+=show_detail("fairness",Math.floor(features/10000) % 10);
			overlays+="</table></div>";
			var current=web3.toDecimal(pledgeContract.last_pledge(pledgeContract.service(number)));
			if(current==0) content+="<td>pledge cancelled</td><td/>";
			else if(current==number+1){
				content+="<td>pledge is active</td>";
				var owner=pledgeContract.owner(service);
				if (account_exists(owner)) {
					content+=("<td><button onclick='cancel_pledge("+number+");'>Cancel</button></td>");
				}
			}
			else content+="<td>pledge outdated - see update</td><td/>";
			content+="</tr>";
		}
		document.getElementById("pledgesList").innerHTML="<table>"+content+"</table>";
		document.getElementById("overlays").innerHTML=overlays;
		var number=count;
		while(number>0){
			number--
			draw_radar(web3.toDecimal(pledgeContract.features(number)),"radar"+number,400);
			document.getElementById("row"+number).addEventListener("mouseenter",function(event){
				var source=event.target.id;
				statisch=event.target;
				var target="detail"+source.substring(3,5);
				var style=document.getElementById(target).style;
				// alert(event.clientX + "-" +event.clientY);
				style.left=event.clientX+100+"px";
				style.top=event.clientY-400+"px";
				style.visibility="visible";
				if(style!=last_overlay && last_overlay != null) last_overlay.visibility="hidden";
				last_overlay=style;
			});
			document.getElementById("row"+number).addEventListener("mouseout",function(event){
				if(last_overlay!=null){
					last_overlay.visibility="hidden";
					last_overlay=null;
				}
			});

		} */
	}

</script>



<style>
	body {
		font-family: 'Open Sans', sans-serif;
		font-size: 11px;
		font-weight: 300;
		fill: #242424;
		text-align: left;
		text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff, 0 -1px 0 #fff;
		cursor: default;
	}

	.legend {
		font-family: 'Raleway', sans-serif;
		fill: #333333;
	}

	.tooltip {
		fill: #333333;
	}

	tr, th, td {
		padding: 1px;
		text-align: left;
		vertical-align: top;
	}

}

</style>
<title>DAISEE</title>
</head>
<body onload="init(); setAccounts();">
<h1>DAISEE</h1>
<h2 id="status"></h2>
<h1>Registration</h1>
<p>Select your account: <select id="account"></select></p>
<p>Name <input type="text" id="name"/></p>
<p><button type="button" onclick="addUser()">Register User</button>

<h1>Energy Status</h1>
<table><tr><th>User</th><th>Usage</th><th>Production</th><th>internal balance</th><th>EDF achat</th><th>EDF vente</th></tr>


</table>

<h1>Manually add Usage and Consumption</h1>
<p>Select User <select id="users"></select></p>
<p>Usage <input type="text" id="usage"></input></p>
<p>Production <input type="text" id="production"></input></p>
<p><button type="button" onclick="setUsage()">Enter</button>

</body></html>
